# 背景
- 响应时间过长，系统资源占用过多，服务不稳定
- 一般的应用系统，读写比例在10:1左右

# 数据库瓶颈
## 分类
- IO瓶颈
  - 磁盘读IO瓶颈，热点数据太多，数据库缓存放不下
    - 每次查询时会产生大量的IO，降低查询速度
      - 分库和垂直分表
  - 网络IO瓶颈，请求的数据太多，网络带宽不够
    - 分库
- CPU瓶颈
  - SQL问题
    - 如SQL中包含join，groupby，orderby，非索引字段条件查询等
      - 增加CPU运算的操作
        - SQL优化，建立合适的索引，在业务Service层进行业务计算
  - 单表数据量太大，查询时扫描的行太多，SQL效率低
    - CPU率先出现瓶颈，水平分表

## 分库
- 分担数据库访问压力
  - 网络IO瓶颈，请求的数据太多，网络带宽不够


# Table division
## 垂直切分
- 字段切分
  - 把业务切割得足够独立，那把不同业务的数据放到不同的数据库服务器上

## 水平切分
- 假设一个场景
  - 将一张表分割成几张表，但是功能上与之前的一样
- 结构
  - 主键问题
    - 自增主键就已经不能用了，创建一个全局唯一主键
      - 分布式全局唯一ID
  - 路由
    - 如分库分表的规则是user_id mod 4的方式
- 原理
  - 系统绝对并发量并没有上来，只是单表的数据量太多
    - 影响了SQL效率，加重了CPU负担，以至于成为瓶颈
- 操作
  - 业务场景
- 带来的问题
  - 事务支持
    - 如果依赖数据库本身的分布式事务管理功能去执行事务
      - 将付出高昂的性能代价 
    - 如果由应用程序去协助控制，形成程序逻辑上的事务
      - 又会造成编程方面的负担  
  - join链接
    - 字段冗余
      - 这样有些字段就不用join去查询

# 上线
## 问题
- 在原系统运行的情况下，如何上线新的数据库结构?      
  1. 停机维护
    - 出公告，半夜上线
  2. 切换数据库链接
    - 带来的问题，用户数据操作失败，给用户带来损失